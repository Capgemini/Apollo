{
  "variables": {
    "aws_access_key": "{{env `AWS_ACCESS_KEY_ID`}}",
    "aws_secret_key": "{{env `AWS_ACCESS_KEY`}}",
    "consul_version": "0.5.0",
    "consul_template_version": "0.7.0",
    "weave_version": "latest_release",
    "build_version": "{{ timestamp }}"
  },
  "builders": [{
    "type": "amazon-ebs",
    "ami_name": "lb-ubuntu-14.04_amd64_{{user `build_version`}}",
    "ami_description": "Ubuntu 14.04 LTS, Docker, Consul {{user `consul_version`}}, Consul Template {{user `consul_template_version`}} and Weave {{user `weave_version`}}.",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "eu-west-1",
    "source_ami": "ami-394ecc4e",
    "instance_type": "m1.medium",
    "ami_groups": "all",
    "ssh_username": "ubuntu",
    "ssh_timeout": "10m",
    "ami_regions": ["eu-west-1"]
  }],
  "provisioners": [
    {
      "type": "file",
      "source": "scripts/common/templates",
      "destination": "/tmp"
    },
    {
      "type": "file",
      "source": "scripts/ubuntu/upstart",
      "destination": "/tmp"
    },
    {
      "type": "shell",
      "environment_vars": [
        "CONSUL_VERSION={{user `consul_version`}}",
        "CONSUL_TEMPLATE_VERSION={{user `consul_template_version`}}",
        "WEAVE_VERSION={{user `weave_version`}}"
      ],
      "scripts": [
        "scripts/ubuntu/base.sh",
        "scripts/common/sshd.sh",
        "scripts/ubuntu/install_docker.sh",
        "scripts/common/install_consul.sh",
        "scripts/common/install_consul_template.sh",
        "scripts/ubuntu/install_haproxy.sh",
        "scripts/common/install_weave.sh"
      ],
      "execute_command": "{{ .Vars }} sudo  -E -S sh '{{ .Path }}'"
    }
  ],
  "push": {
    "name": "capgemini/lb-ubuntu-14-04"
  },
  "post-processors": [{
    "type": "atlas",
    "token": "{{env `ATLAS_TOKEN`}}",
    "artifact": "capgemini/lb_ubuntu-14.04_amd64",
    "artifact_type": "aws.ami",
    "metadata": {
      "created_at": "{{timestamp}}"
    }
  }]
}
