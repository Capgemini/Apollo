- include: site.yml
  vars:
    haproxy_ssl_enabled: True

- hosts: localhost
  connection: local
  tasks:
    - pause: prompt="Continue?"

- hosts: mesos_slaves_docker
  name: remove slave from pool
  sudo: yes
  serial: 1
  tasks:
    - name: collect running tasks
      shell: >
        docker ps | grep mesos-[0-9a-f] | awk '{print $1, $2, $NF}'
      register: running_tasks
    - name: The following will be terminated
      debug: msg="{{ item }}"
      with_items: running_tasks.stdout_lines
    - pause:
        minutes: 1
    - name: stop mesos-slave and tasks
      shell: >
        stop mesos-slave;
        docker stop mesos-slave | xargs docker rm -v -f;
        docker ps | grep mesos-[0-9a-f] | awk '{print $1}' | xargs -r docker stop | xargs -r docker rm -v -f;
    - debug: 
        msg: "slave on {{ ansible_ssh_host }} is down. Pausing for up to 5 minutes."
    - pause:
        minutes: 4
  post_tasks:
    - action: ec2_facts
    - name: "De-register slave with load balancer"
      local_action:
        module: ec2_elb
        instance_id: "{{ ansible_ec2_instance_id }}"
        state: absent
        wait: yes
      sudo: false
