---
# tasks file for haproxy
- name: "assures {{ consul_template_dir }} dirs exists"
  file:
    path: "{{ consul_template_dir }}/{{ item.path }}"
    state: directory
  with_items:
    - { path: 'config' }
    - { path: 'templates' }
  tags:
    - haproxy

- name: upload template config files
  template:
    src: consul.cfg.j2
    dest: "{{ consul_template_dir }}/config/consul.cfg"
    mode: 0644
  sudo: yes
  tags:
    - haproxy

- name: upload static config files
  copy:
    src: "{{ item.src }}"
    dest: "{{ consul_template_dir }}/{{ item.dst }}"
    mode: 0644
  sudo: yes
  with_items:
    - { src: haproxy.cfg, dst: 'config/haproxy.cfg' }
    - { src: haproxy.tmpl, dst: 'templates/haproxy.tmpl' }
  tags:
    - haproxy

- name: destroy old haproxy container
  when: haproxy_rebuild_container
  docker:
    name: haproxy
    image: "{{ haproxy_image }}"
    state: absent
  tags:
    - haproxy

- name: run haproxy container
  # NOTE: Using command until we update to Ansible 2.0 which supports --log-driver
  command: >
    docker run -d 
    --name=haproxy
    --net=host 
    --restart=always 
    --log-driver=syslog
    -p 0.0.0.0:80:80/tcp
    -p 0.0.0.0:34180:34180/tcp
    -e HAPROXY_DOMAIN="{{ haproxy_domain }}"
    -e CONSUL_TEMPLATE_VERSION="{{ consul_template_version }}"
    -e CONSUL_LOGLEVEL="{{ consul_template_loglevel }}"
    -e CONSUL_CONNECT="{{ consul_backend }}"
    -e CONSUL_CONFIG="/config"
    -e SERVICE_NAME=haproxy
    -v "/dev/log:/dev/log:rw"
    -v "{{ consul_template_dir }}/config:/config:rw"
    -v "{{ consul_template_dir }}/templates:/templates:rw"
    "{{ haproxy_image }}"
  register: command_result
  failed_when: 'The name "haproxy" is already in use' in command_result.stderr
  tags:
    - haproxy

